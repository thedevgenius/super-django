{% extends 'base.html' %}
{% block content %}
<div class="max-w-sm mx-auto mt-10 bg-white shadow p-6 rounded text-center">
    <h2 class="text-xl font-bold mb-4">Verify OTP</h2>

    <p class="text-gray-700 mb-2">OTP sent to <strong>{{ phone }}</strong></p>

    <form method="post" id="verifyForm" class="space-y-4">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">
            Verify
        </button>
    </form>

    <div class="mt-4">
        <button id="resendBtn" class="text-blue-600 underline disabled:opacity-50" disabled>
            Resend OTP (<span id="timer">60</span>s)
        </button>
    </div>

    <p id="message" class="mt-3 text-sm text-gray-500"></p>
</div>

<script>
    let seconds = 60;
    const timerDisplay = document.getElementById('timer');
    const resendBtn = document.getElementById('resendBtn');
    const message = document.getElementById('message');

    const countdown = setInterval(() => {
        seconds--;
        timerDisplay.textContent = seconds;
        if (seconds <= 0) {
            clearInterval(countdown);
            resendBtn.disabled = false;
            timerDisplay.textContent = "0";
        }
    }, 1000);

    resendBtn.addEventListener('click', () => {
        resendBtn.disabled = true;
        message.textContent = "Resending OTP...";

        fetch("{% url 'resend-otp' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
        })
            .then((res) => res.json())
            .then((data) => {
                if (data.success) {
                    message.textContent = "OTP resent successfully!";
                    seconds = 60;
                    resendBtn.disabled = true;
                    const countdown2 = setInterval(() => {
                        seconds--;
                        timerDisplay.textContent = seconds;
                        if (seconds <= 0) {
                            clearInterval(countdown2);
                            resendBtn.disabled = false;
                            timerDisplay.textContent = "0";
                        }
                    }, 1000);
                } else {
                    message.textContent = data.error || "Error resending OTP.";
                    resendBtn.disabled = false;
                }
            })
            .catch(() => {
                message.textContent = "Something went wrong.";
                resendBtn.disabled = false;
            });
    });
</script>
{% endblock %}